# render.yaml â€” Django API on Render (fixed)
# - Pins Python 3.11 for compatibility
# - Binds Gunicorn to 0.0.0.0:$PORT
# - Health check hits /api/ (DRF root)
# - Runs migrations in preDeployCommand (runtime)

databases:
  - name: royalroad-db
    plan: basic-256mb
    databaseName: royalroad
    user: royalroad

services:
  - type: web
    name: royalroad-api
    runtime: python
    plan: starter
    autoDeploy: true
    healthCheckPath: /api/
    # branch: main   # (optional) defaults to the branch containing render.yaml

    buildCommand: |
      pip install -r requirements.txt
      pip install "whitenoise[brotli]" gunicorn dj-database-url psycopg2-binary
      python manage.py collectstatic --no-input

    # Run DB migrations in the runtime environment, not during build.
    preDeployCommand: |
      python manage.py migrate

    # IMPORTANT: bind to Render's PORT env on 0.0.0.0
    startCommand: gunicorn royalroad_clone.wsgi:application --bind 0.0.0.0:$PORT

    envVars:
      - key: DJANGO_SETTINGS_MODULE
        value: royalroad_clone.settings_prod
      - key: DATABASE_URL
        fromDatabase:
          name: royalroad-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      # Allow Render subdomains; add your custom domain(s) later.
      - key: ALLOWED_HOSTS
        value: ".onrender.com"
      # Django requires full scheme for trusted origins; wildcard subdomain allowed.
      - key: CSRF_TRUSTED_ORIGINS
        value: "https://*.onrender.com"
      # Pin Python version (Render defaults to 3.13+ for new services).
      - key: PYTHON_VERSION
        value: "3.11.11"
      - key: WEB_CONCURRENCY
        value: "2"
